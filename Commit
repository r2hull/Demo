import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.mail.MessagingException;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMultipart;
import javax.mail.util.ByteArrayDataSource;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

private static final String STATIC_BOUNDARY = "CUSTOM_BOUNDARY_12345"; // Fixed boundary

private String createMultipartResponse(CaptchaResponse captchaResponse, DataSource audioDataSource, RequestType requestType) {
    logger.info("Creating multipart response for RequestId: {}", captchaResponse.getRequestId());

    try {
        // Create MimeMultipart with a generated boundary
        MimeMultipart mimeMultipart = new MimeMultipart("mixed");

        // Add JSON Part
        MimeBodyPart jsonPart = new MimeBodyPart();
        jsonPart.setContent(convertToJson(captchaResponse, requestType), "application/json; charset=UTF-8");
        mimeMultipart.addBodyPart(jsonPart);

        // Add Audio File Part
        MimeBodyPart filePart = new MimeBodyPart();
        filePart.setDataHandler(new DataHandler(audioDataSource));
        filePart.setFileName("speech.wav");
        mimeMultipart.addBodyPart(filePart);

        // Convert MimeMultipart to a string with the fixed boundary
        return rewriteBoundary(mimeMultipart, STATIC_BOUNDARY);

    } catch (MessagingException | IOException e) {
        logger.error("Error creating multipart response for RequestId: {}", captchaResponse.getRequestId(), e);
        throw new MerchantException(ErrorConstants.GENERATION_ERROR_CODE,
                MessageFormat.format(ErrorConstants.GENERATION_ERROR_MESSAGE, requestType.name()));
    }
}

/**
 * This method rewrites the generated boundary to a fixed one.
 */
private String rewriteBoundary(MimeMultipart multipart, String fixedBoundary) throws IOException, MessagingException {
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    multipart.writeTo(outputStream);
    
    // Replace the dynamically generated boundary with our fixed one
    String originalContent = outputStream.toString(StandardCharsets.UTF_8);
    
    // Extract auto-generated boundary (it follows 'boundary=' in Content-Type)
    String contentType = multipart.getContentType();
    String autoGeneratedBoundary = contentType.substring(contentType.indexOf("boundary=") + 9).replaceAll("\"", "").trim();

    // Replace the boundary everywhere in the response
    return originalContent.replace(autoGeneratedBoundary, fixedBoundary);
}