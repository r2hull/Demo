import javax.activation.DataSource;
import javax.activation.DataHandler;
import javax.mail.MessagingException;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMultipart;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

private static final String STATIC_BOUNDARY = "CUSTOM_BOUNDARY_12345"; // Fixed boundary

private MimeMultipart createMultipartResponse(CaptchaResponse captchaResponse, DataSource audioDataSource, RequestType requestType) {
    logger.info("Creating multipart response for RequestId: {}", captchaResponse.getRequestId());

    MimeMultipart mimeMultipart = new MimeMultipart("mixed"); // JavaMail will generate its own boundary

    try {
        // Add JSON Part
        MimeBodyPart jsonPart = new MimeBodyPart();
        jsonPart.setContent(convertToJson(captchaResponse, requestType), "application/json; charset=UTF-8");
        mimeMultipart.addBodyPart(jsonPart);

        // Add Audio File Part
        MimeBodyPart filePart = new MimeBodyPart();
        filePart.setDataHandler(new DataHandler(audioDataSource));
        filePart.setFileName("speech.wav");
        mimeMultipart.addBodyPart(filePart);

        // Convert MimeMultipart to a fixed boundary format
        return rewriteBoundary(mimeMultipart, STATIC_BOUNDARY);

    } catch (MessagingException | IOException e) {
        logger.error("Error creating multipart response for RequestId: {}", captchaResponse.getRequestId(), e);
        throw new MerchantException(ErrorConstants.GENERATION_ERROR_CODE,
                MessageFormat.format(ErrorConstants.GENERATION_ERROR_MESSAGE, requestType.name()));
    }
}

/**
 * This method intercepts the multipart email, replaces the auto-generated boundary with a static one.
 */
private MimeMultipart rewriteBoundary(MimeMultipart multipart, String fixedBoundary) throws IOException, MessagingException {
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    multipart.writeTo(outputStream);
    
    // Replace the randomly generated boundary with our fixed one
    String originalContent = outputStream.toString(StandardCharsets.UTF_8);
    String autoGeneratedBoundary = multipart.getContentType().split("boundary=")[1]; // Extract original boundary
    String modifiedContent = originalContent.replace(autoGeneratedBoundary, fixedBoundary);

    return new MimeMultipart(new javax.mail.util.ByteArrayDataSource(modifiedContent, "multipart/mixed; boundary=" + fixedBoundary));
}