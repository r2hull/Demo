private void persistMerchantOrderAccounts(
        OrderDto orderDto,
        MerchantBankAccountsDetailDto bankDetails) {

    List<MultiAccountDto> multiAccounts =
            orderValidator.getMultiAccountDtos(orderDto);

    List<MerchantOrderAccountInfo> entities =
            buildMerchantOrderAccountInfos(orderDto, bankDetails, multiAccounts);

    merchantOrderAccountInfoRepository.saveAll(entities);
}



private List<MerchantOrderAccountInfo> buildMerchantOrderAccountInfos(
        OrderDto orderDto,
        MerchantBankAccountsDetailDto bankDetails,
        List<MultiAccountDto> multiAccounts) {

    if (multiAccounts == null || multiAccounts.isEmpty()) {
        return List.of(buildFromPrimaryAccount(orderDto, bankDetails));
    }

    return buildFromMultiAccounts(orderDto, bankDetails, multiAccounts);
}


private MerchantOrderAccountInfo buildFromPrimaryAccount(
        OrderDto orderDto,
        MerchantBankAccountsDetailDto bankDetails) {

    BankAccountDto primary = bankDetails.getPrimaryAccount();

    return buildEntity(
            orderDto,
            primary,
            orderDto.getOrderAmount(),
            AccountType.P
    );
}



private List<MerchantOrderAccountInfo> buildFromMultiAccounts(
        OrderDto orderDto,
        MerchantBankAccountsDetailDto bankDetails,
        List<MultiAccountDto> multiAccounts) {

    List<MerchantOrderAccountInfo> result = new ArrayList<>();

    for (MultiAccountDto multiAccount : multiAccounts) {

        BankAccountDto bankAccount =
                resolveBankAccount(bankDetails, multiAccount.getAccountIdentifier());

        AccountType accountType =
                isPrimary(bankAccount) ? AccountType.P : AccountType.S;

        result.add(
                buildEntity(
                        orderDto,
                        bankAccount,
                        multiAccount.getAmount(),
                        accountType
                )
        );
    }
    return result;
}



private BankAccountDto resolveBankAccount(
        MerchantBankAccountsDetailDto bankDetails,
        String accountIdentifier) {

    BankAccountDto primary = bankDetails.getPrimaryAccount();

    if (primary != null &&
        accountIdentifier.equalsIgnoreCase(primary.getAccountNickName())) {
        return primary;
    }

    return bankDetails.getSecondaryAccount()
            .stream()
            .filter(acc ->
                    accountIdentifier.equalsIgnoreCase(acc.getAccountNickName()))
            .findFirst()
            .orElseThrow(() ->
                    new IllegalArgumentException(
                            "Invalid accountIdentifier: " + accountIdentifier));
}


private boolean isPrimary(BankAccountDto account) {
    return "Y".equalsIgnoreCase(account.getPrimaryAccount());
}


private MerchantOrderAccountInfo buildEntity(
        OrderDto orderDto,
        BankAccountDto account,
        BigDecimal amount,
        AccountType accountType) {

    return MerchantOrderAccountInfo.builder()
            .orderId(orderDto.getSbiOrderRefNumber())
            .accountHeader(account.getAccountNickName())
            .accountNumber(account.getAccountNumber())
            .amount(amount)
            .accountType(accountType)
            .accountClassification(orderDto.getAccountClassification())
            .build();
}


