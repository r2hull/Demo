public TokenManagement getValidTokenIfNotExpiringSoon(
        String userName, String phoneNumber, String tokenType) {

    long now = System.currentTimeMillis();
    long oneMinLater = now + 60_000L; // 1 minute baad

    return repo.findValidActiveToken(userName, phoneNumber, tokenType, now)
               .filter(token -> token.getTokenExpiryTime() > oneMinLater) // 1 min se jyada bacha ho
               .orElse(null); // nahi toh null â†’ matlab token expire hone wala hai, naya banao
}



@Query("""
    SELECT t FROM TokenManagement t 
    WHERE t.userName = :userName 
      AND t.phoneNumber = :phoneNumber 
      AND t.tokenType = :tokenType 
      AND t.isActive = true 
      AND t.tokenExpiryTime > :currentTime
    """)
Optional<TokenManagement> findValidActiveToken(
    @Param("userName") String userName,
    @Param("phoneNumber") String phoneNumber, 
    @Param("tokenType") String tokenType,
    @Param("currentTime") long currentTime);