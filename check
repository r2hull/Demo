package com.epay.rns.helpers;

import com.epay.rns.beans.SftpServerBean;
import com.epay.rns.server.SFTPServer;
import org.apache.sshd.common.NamedFactory;
import org.apache.sshd.common.file.virtualfs.VirtualFileSystemFactory;
import org.apache.sshd.server.SshServer;
import org.apache.sshd.server.auth.UserAuth;
import org.apache.sshd.server.auth.password.UserAuthPasswordFactory;
import org.apache.sshd.server.command.Command;
import org.apache.sshd.server.keyprovider.SimpleGeneratorHostKeyProvider;
import org.apache.sshd.server.shell.ProcessShellCommandFactory;
import org.apache.sshd.server.subsystem.sftp.SftpSubsystemFactory;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;

public class SftpServerUtils {
    public static SftpServerBean setupSftpServer(String username, String password, int port) throws IOException {
        Path tempSftpDir = Paths.get("C:\\SFTP");
        Path rnsDir = tempSftpDir.resolve("RnS");
        Path sbiDir = rnsDir.resolve("SBI");
        Path hdfcDir = rnsDir.resolve("HDFC");
        Path bobDir = rnsDir.resolve("BOB");
        Path processedDir = tempSftpDir.resolve("processed"); // New processed folder
        for (Path dir : Arrays.asList(rnsDir, sbiDir, hdfcDir, bobDir, processedDir)) {
            if (!Files.exists(dir)) {
                Files.createDirectories(dir);
            }
        }

        List<NamedFactory<UserAuth>> userAuthFactories = new ArrayList<>();
        userAuthFactories.add(new UserAuthPasswordFactory());

        List<NamedFactory<Command>> sftpCommandFactory = new ArrayList<>();
        sftpCommandFactory.add(new SftpSubsystemFactory());

        SshServer sshd = SshServer.setUpDefaultServer();
        sshd.setPort(port);
        sshd.setKeyPairProvider(new SimpleGeneratorHostKeyProvider());
        sshd.setUserAuthFactories(userAuthFactories);
        sshd.setCommandFactory(new ProcessShellCommandFactory());
        sshd.setSubsystemFactories(sftpCommandFactory);
        sshd.setPasswordAuthenticator((usernameAuth, passwordAuth, session) -> {
            if ((username.equals(usernameAuth)) && (password.equals(passwordAuth))) {
                sshd.setFileSystemFactory(new VirtualFileSystemFactory(tempSftpDir));
                return true;
            }
            return false;
        });

        sshd.start();
        System.out.println("Started SFTP server with root path: " + tempSftpDir.toFile().getAbsolutePath());
        return new SftpServerBean(sshd, tempSftpDir);
    }

    public static void stopServer(SftpServerBean sftpServerBean) throws IOException {
        sftpServerBean.getSshServer().stop();
        // Optionally, skip deleting processed folder if you want to keep it
        Files.walk(sftpServerBean.getRootPath())
                .sorted(Comparator.reverseOrder())
                .map(Path::toFile)
                .forEach(File::delete);
    }
}




package com.epay.rns.utils;

import com.jcraft.jsch.*;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

public class SftpClientUtil {
    private String host;
    private String username;
    private String password;
    private int port;
    private Session session;
    private ChannelSftp channelSftp;

    public SftpClientUtil(String host, String username, String password, int port) {
        this.host = host;
        this.username = username;
        this.password = password;
        this.port = port;
    }

    public void connect() throws JSchException {
        JSch jsch = new JSch();
        session = jsch.getSession(username, host, port);
        session.setPassword(password);
        session.setConfig("StrictHostKeyChecking", "no");
        System.out.println("Connecting to " + host + ":" + port + " with user " + username);
        session.connect();
        channelSftp = (ChannelSftp) session.openChannel("sftp");
        channelSftp.connect();
    }

    public void disconnect() {
        if (channelSftp != null && channelSftp.isConnected()) {
            channelSftp.exit();
        }
        if (session != null && session.isConnected()) {
            session.disconnect();
        }
    }

    public void downloadFile(String remoteFilePath, String localFilePath) throws JSchException, SftpException {
        channelSftp.get(remoteFilePath, localFilePath);
    }

    // New method to move a file on the server
    public void moveFile(String sourcePath, String destinationPath) throws SftpException {
        try {
            channelSftp.rename(sourcePath, destinationPath);
        } catch (SftpException e) {
            throw new SftpException(e.id, "Failed to move file from " + sourcePath + " to " + destinationPath + ": " + e.getMessage());
        }
    }

    public List<FileInfo> findFilesModifiedWithinLastHour(List<String> remoteSubfolders) throws SftpException {
        List<FileInfo> recentFiles = new ArrayList<>();
        long currentTime = System.currentTimeMillis();
        long oneHourAgo = currentTime - 3600_000; // 1 hour in milliseconds

        for (String subfolder : remoteSubfolders) {
            try {
                Vector<ChannelSftp.LsEntry> files = channelSftp.ls(subfolder);
                for (ChannelSftp.LsEntry entry : files) {
                    if (!entry.getAttrs().isDir() && !entry.getFilename().equals(".") && !entry.getFilename().equals("..")) {
                        long mTime = entry.getAttrs().getMTime() * 1000L;
                        if (mTime >= oneHourAgo) {
                            FileInfo fileInfo = new FileInfo();
                            fileInfo.setFolder(subfolder);
                            fileInfo.setFileName(entry.getFilename());
                            fileInfo.setRemotePath(subfolder + "/" + entry.getFilename());
                            fileInfo.setModificationTime(mTime);
                            recentFiles.add(fileInfo);
                        }
                    }
                }
            } catch (SftpException e) {
                System.err.println("Error listing files in " + subfolder + ": " + e.getMessage());
            }
        }

        return recentFiles;
    }

    public static class FileInfo {
        private String folder;
        private String fileName;
        private String remotePath;
        private long modificationTime;

        public String getFolder() {
            return folder;
        }

        public void setFolder(String folder) {
            this.folder = folder;
        }

        public String getFileName() {
            return fileName;
        }

        public void setFileName(String fileName) {
            this.fileName = fileName;
        }

        public String getRemotePath() {
            return remotePath;
        }

        public void setRemotePath(String remotePath) {
            this.remotePath = remotePath;
        }

        public long getModificationTime() {
            return modificationTime;
        }

        public void setModificationTime(long modificationTime) {
            this.modificationTime = modificationTime;
        }
    }
}








